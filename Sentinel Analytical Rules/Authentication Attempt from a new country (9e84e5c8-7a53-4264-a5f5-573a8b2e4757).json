{
    "contentVersion":  "1.0.0.0",
    "$schema":  "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "resources":  [
                      {
                          "id":  "[concat(resourceId(\u0027Microsoft.OperationalInsights/workspaces/providers\u0027, parameters(\u0027workspace\u0027), \u0027Microsoft.SecurityInsights\u0027),\u0027/alertRules/9e84e5c8-7a53-4264-a5f5-573a8b2e4757\u0027)]",
                          "name":  "[concat(parameters(\u0027workspace\u0027),\u0027/Microsoft.SecurityInsights/9e84e5c8-7a53-4264-a5f5-573a8b2e4757\u0027)]",
                          "type":  "Microsoft.OperationalInsights/workspaces/providers/alertRules",
                          "kind":  "Scheduled",
                          "apiVersion":  "2023-12-01-preview",
                          "properties":  {
                                             "displayName":  "Authentication Attempt from a new country",
                                             "description":  "Test - Mustafa",
                                             "severity":  "Medium",
                                             "enabled":  true,
                                             "query":  "let KnownLocations = SigninLogs\r\n    | where TimeGenerated between(ago(14d) .. ago(1h))\r\n    | where ResultType == 0\r\n    | summarize UserKnownLocation = make_set(Location) by UserPrincipalName;\r\nlet AnomalousSignIn = SigninLogs\r\n    | where TimeGenerated \u003e ago(1h) // CHANGE IT DEPENDING ON RULE FREQUENCY\r\n    | where ResultType in (0,500121)\r\n    | where isnotempty(Location)\r\n    | join kind=leftouter KnownLocations on UserPrincipalName\r\n    | where tostring(parse_json(DeviceDetail).trustType) == \"\"\r\n    | extend AnomalousLocationDetail = Location\r\n    | where not(UserKnownLocation has AnomalousLocationDetail);\r\nlet ManagedAttempts = SigninLogs\r\n    | union AADNonInteractiveUserSignInLogs\r\n    | where TimeGenerated \u003e ago(14d)\r\n    | where (tostring(parse_json(DeviceDetail_dynamic).trustType) != \"\" or tostring(parse_json(DeviceDetail_string).trustType) != \"\") or (DeviceDetail_dynamic or DeviceDetail_string contains \"PII Removed\")\r\n    | summarize IPManagedAttempts = count() by IPAddress;\r\nlet NonInterKnownLocation = AADNonInteractiveUserSignInLogs\r\n    | where TimeGenerated between (ago(14d) .. ago(1h))\r\n    | where ResultType == 0\r\n    | summarize NonInterKnownLocations = make_set(Location) by UserPrincipalName;\r\nlet AnomalousNonInterSignin = AADNonInteractiveUserSignInLogs\r\n    | where TimeGenerated \u003e ago(1h)\r\n    | join kind=leftouter NonInterKnownLocation on UserPrincipalName\r\n    | where ResultType != 50126 and ResultType != 50053\r\n    | where isnotempty(Location)\r\n    | where not(NonInterKnownLocations has Location)\r\n    | where Location in (\"RU\", \"UA\", \"DZ\", \"AO\", \"BJ\", \"BW\", \"BF\", \"BI\", \"CM\", \"CV\", \"CF\", \"TD\", \"KM\", \"CD\", \"CI\", \"DJ\", \"EG\", \"GQ\", \"ER\", \"SZ\", \"ET\", \"GA\", \"GM\", \"GH\", \"GW\", \"KE\", \"LS\", \"LR\", \"MG\", \"MW\", \"ML\", \"MR\", \"MU\", \"YT\", \"MA\", \"MZ\", \"NA\", \"NE\", \"NG\", \"RE\", \"RW\", \"SH\", \"ST\", \"SN\", \"SC\", \"SL\", \"SO\", \"ZA\", \"SS\", \"SD\", \"TZ\", \"TG\", \"TN\", \"UG\", \"EG\")\r\n    | summarize\r\n        Device = make_set(DeviceDetail),\r\n        ClientApp =make_set(ClientAppUsed),\r\n        Set_Result = make_set(ResultType),\r\n        Set_Status = make_set(Status),\r\n        Applications = make_set(AppDisplayName),\r\n        RiskType = make_set(RiskEventTypes),\r\n        RiskTypeV2 = make_set(RiskEventTypes_V2),\r\n        UserAgent = make_set(UserAgent),\r\n        Time = make_set(TimeGenerated, 1),\r\n        NormalLocationsfrom2weeks = make_set(NonInterKnownLocations),\r\n        AuthDetails = make_set(AuthenticationDetails)\r\n        by UserPrincipalName, IPAddress, Location, Type\r\n    | join kind=leftouter ManagedAttempts on IPAddress\r\n    | extend IPManagedAttempts = coalesce(IPManagedAttempts, 0)\r\n    | project-away IPAddress1\r\n    | project-reorder\r\n        Time,\r\n        UserPrincipalName,\r\n        IPAddress,\r\n        Location,\r\n        NormalLocationsfrom2weeks,\r\n        Type,\r\n        Set_Result,\r\n        Set_Status,\r\n        AuthDetails,\r\n        Applications,\r\n        Device,\r\n        ClientApp,\r\n        UserAgent,\r\n        RiskType,\r\n        RiskTypeV2,\r\n        IPManagedAttempts\r\n    | where IPManagedAttempts == 0;\r\nlet GetEmailDetails = SigninLogs\r\n| where TimeGenerated \u003e ago(14d)\r\n| where isnotempty(DeviceDetail.operatingSystem ) or isnotempty(parse_json(DeviceDetail).browser )\r\n| extend Device = iff(isempty( DeviceDetail.operatingSystem),(tostring(parse_json(DeviceDetail).browser)),(tostring(parse_json(DeviceDetail).operatingSystem)))\r\n| extend Device = iff(Device contains \"Safari\",\"Ios \",Device)\r\n| summarize Devices = make_set(Device), ResultType = make_set(ResultType), AuthenticationRequirement = make_set(AuthenticationRequirement) by UserPrincipalName,IPAddress,Location,LocationDetail = strcat(Location, \"-\", LocationDetails.state)\r\n| extend SuccessorFailed = iff(array_index_of(ResultType, \"0\") != -1, \"successful\", \"failed\");\r\nAnomalousSignIn\r\n| summarize\r\n    Device = make_set(DeviceDetail),\r\n    ClientApp =make_set(ClientAppUsed),\r\n    Set_Result = make_set(ResultType),\r\n    Set_Status = make_set(Status),\r\n    Applications = make_set(AppDisplayName),\r\n    RiskType = make_set(RiskEventTypes),\r\n    RiskTypeV2 = make_set(RiskEventTypes_V2),\r\n    UserAgent = make_set(UserAgent),\r\n    Time = min(TimeGenerated),\r\n    NormalLocationsfrom2weeks = make_set(UserKnownLocation),\r\n    AuthDetails = make_set(AuthenticationDetails)\r\n    by UserPrincipalName, IPAddress, AnomalousLocationDetail\r\n| join kind=leftouter ManagedAttempts on IPAddress\r\n| extend IPManagedAttempts = coalesce(IPManagedAttempts, 0)\r\n| project-away IPAddress1\r\n| join kind=leftouter GetEmailDetails on UserPrincipalName,IPAddress,$left.AnomalousLocationDetail == $right.Location\r\n| extend formatted_time = format_datetime(todatetime(Time), \u0027yyyy-MM-dd HH:mm\u0027)\r\n| extend AuthRequirement = iff(AuthenticationRequirement contains \"multifactor\", \u0027multifactor authentication\u0027, \u0027singlefactor authentication\u0027)\r\n| extend EmailTemplate = strcat(\"Hi,\\n\\nKindly note that an alert was raised on \", formatted_time, \" [UTC] due to the user \", UserPrincipalName, \" having unfamiliar sign-in properties. Upon our investigations, we found that the user had \", SuccessorFailed,\" \", AuthRequirement, \" attempts accessing the applications \", Applications, \" from the IP address \", IPAddress, \" which classified as (CLEAN OR VPN) and is located in \", LocationDetail, \". The attempt was through non-managed and non-compliant \", Devices, \" device.\\n\\nKindly note that the user\u0027s previous login locations is from \", NormalLocationsfrom2weeks, \".\\n\\nCan you please confirm if this is an expected activity?\\n\\nRegards,\\n\\nSOC\")\r\n| project-reorder\r\n    Time,\r\n    UserPrincipalName,\r\n    IPAddress,\r\n    AnomalousLocationDetail,\r\n    NormalLocationsfrom2weeks,\r\n    Set_Result,\r\n    Set_Status,\r\n    AuthDetails,\r\n    Applications,\r\n    Device,\r\n    ClientApp,\r\n    UserAgent,\r\n    RiskType,\r\n    RiskTypeV2,\r\n    EmailTemplate,\r\n    IPManagedAttempts\r\n| project-away UserPrincipalName1,IPAddress1,Location,formatted_time,AuthRequirement\r\n| where IPManagedAttempts == 0",
                                             "queryFrequency":  "PT5M",
                                             "queryPeriod":  "PT2H",
                                             "triggerOperator":  "GreaterThan",
                                             "triggerThreshold":  0,
                                             "suppressionDuration":  "PT5H",
                                             "suppressionEnabled":  false,
                                             "startTimeUtc":  null,
                                             "tactics":  [

                                                         ],
                                             "techniques":  [

                                                            ],
                                             "subTechniques":  [

                                                               ],
                                             "alertRuleTemplateName":  null,
                                             "incidentConfiguration":  {
                                                                           "createIncident":  true,
                                                                           "groupingConfiguration":  {
                                                                                                         "enabled":  false,
                                                                                                         "reopenClosedIncident":  false,
                                                                                                         "lookbackDuration":  "PT5H",
                                                                                                         "matchingMethod":  "AllEntities",
                                                                                                         "groupByEntities":  [

                                                                                                                             ],
                                                                                                         "groupByAlertDetails":  [

                                                                                                                                 ],
                                                                                                         "groupByCustomDetails":  [

                                                                                                                                  ]
                                                                                                     }
                                                                       },
                                             "eventGroupingSettings":  {
                                                                           "aggregationKind":  "SingleAlert"
                                                                       },
                                             "alertDetailsOverride":  null,
                                             "customDetails":  {

                                                               },
                                             "entityMappings":  [
                                                                    {
                                                                        "entityType":  "Account",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "FullName",
                                                                                                  "columnName":  "UserPrincipalName"
                                                                                              }
                                                                                          ]
                                                                    },
                                                                    {
                                                                        "entityType":  "IP",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "Address",
                                                                                                  "columnName":  "IPAddress"
                                                                                              }
                                                                                          ]
                                                                    },
                                                                    {
                                                                        "entityType":  "Account",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "Name",
                                                                                                  "columnName":  "AnomalousLocationDetail"
                                                                                              }
                                                                                          ]
                                                                    }
                                                                ],
                                             "sentinelEntitiesMappings":  null,
                                             "templateVersion":  null
                                         }
                      }
                  ],
    "parameters":  {
                       "workspace":  {
                                         "type":  "String"
                                     }
                   }
}